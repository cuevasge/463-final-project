---
title: "Final Project"
author: "Gabriela Cuevas & Max Baumstark"
date: "2025-11-10"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Introduction
In this report, we will investigate how environmental factors such as ocean temperature, pH level, bleaching level, latitude, and longitude impact marine biodiversity. Our data is assembled from various climate organization research (NOAA, GODAP, OBIS) assembled for the purpose of finding climate trends and creating future predictions. We will perform model diagnostics and multiple regression to determine which factors are most significant. 
### Data Cleaning and Filtering
```{r}
rm(list = ls())

library(readxl)   # to read Excel files
library(dplyr)    # for data cleaning
library(janitor)  # to clean column names
library(tidyverse)
library(gridExtra)
library(zoo)
library(lmtest)
library(nortest)
library(car)
library(ggplot2)

setwd("/Users/gabrielacuevas/Desktop/STA 463/FinalProject")
dat = read.csv("ocean.csv",header=T)

head(dat)
tail(dat)

dim(dat)
```

```{r}
clean_dat <- dat %>% 
  select (-Marine.Heatwave) %>%  # remove 2 columns
   rename(
     temperature = SST,
     pH = pH.Level,
     species = Species.Observed,
     bleachLevel = Bleaching.Severity
   )
 
# convert species to integer
clean_dat$species <- as.integer(clean_dat$species)
# filter for Great Barrier Reef
GBR_dat <- clean_dat %>%
   filter(Location == "Great Barrier Reef")


head(GBR_dat)

```
### Create Dummy for Bleach Level
```{r}
GBR_dat$highBleach <- ifelse(GBR_dat$bleachLevel == "High", 1, 0)
GBR_dat$mediumBleach <- ifelse(GBR_dat$bleachLevel == "Medium", 1, 0)
GBR_dat$lowBleach <- ifelse(GBR_dat$bleachLevel == "Low", 1, 0)
GBR_dat <- GBR_dat %>% 
  select (-bleachLevel)

head(GBR_dat)
tail(GBR_dat)
```

## Plot Temp against Number of Species
```{r}
temp <- ggplot(GBR_dat, aes(x = temperature, y = species)) +
  geom_point(size = 3) +  # dots
  geom_smooth(method = "lm", se = FALSE, color = "red") +  # linear regression line
  labs(
    title = "Number of Species by Temperature for the Great Barrier Reef",
    x = "Temperature",
    y = "Number of Species"
  ) +
  ylim(0, 170) +
  scale_x_continuous(breaks = seq(min(GBR_dat$temperature), max(GBR_dat$temperature), by = 1))+
  theme_minimal()
temp
```
## Fitting a Multiple Regression Model
```{r}
lm_ocean_full <- lm(species ~ temperature + pH + Latitude + Longitude + highBleach + mediumBleach + lowBleach, data = GBR_dat)
summary(lm_ocean_full)

lm_ocean_long <- lm(species ~ temperature + Longitude, data = GBR_dat)
summary(lm_ocean_long)

lm_ocean_reduced <- lm(species ~ temperature, data = GBR_dat)
summary(lm_ocean_reduced)

```

## Visualize all predictors
```{r}
avPlots(lm_ocean_full)
```
From these added variable plots, we can see that the only predictor besides temperature that has a notable relationship with the number of species is longitude. In that plot, there is a slight positive correlation between number of species and longitude. This tells us that there is higher biodiversity in the southern parts of the Great Barrier Reef. This graph also highlights 62, 42, and 32 as outliers, which matches up with our cook's distance plot.


## Check Model Assumptions
```{r}
GBR_dat$fit_full <- fitted(lm_ocean_full)
GBR_dat$fit_red <- fitted(lm_ocean_reduced)

p1 <- ggplot(GBR_dat, aes(x = species, y = fit_full)) +
geom_point(color = "steelblue") +
geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
labs(
title = "Full Model: Fitted vs Actual",
x = "Actual num of species",
y = "Fitted num of species"
) +
theme_minimal()

p2 <- ggplot(GBR_dat, aes(x = species, y = fit_red)) +
geom_point(color = "darkorange") +
geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
labs(
title = "Reduced Model: Fitted vs Actual",
x = "Actual num of species",
y = "Fitted num of species"
) +
theme_minimal()

grid.arrange(p1, p2, ncol = 2)
```


```{r}
par(mfrow = c(2, 2))
plot(lm_ocean_full)
par(mfrow = c(1, 1))

```
```{r}
shapiro.test(residuals(lm_ocean_full))
```
```{r}
par(mfrow = c(2, 2))
plot(lm_ocean_reduced)
par(mfrow = c(1, 1))
```

```{r}
shapiro.test(residuals(lm_ocean_reduced))
```
Check homoscedasticity

```{r}
plot(fitted(lm_ocean_full), residuals(lm_ocean_full),
main = "Residuals vs Fitted (Homoscedasticity Check)",
xlab = "Fitted Values", ylab = "Residuals", pch = 19, col = "blue")
abline(h = 0, col = "red", lwd = 2)
```

```{r}
plot(fitted(lm_ocean_reduced), residuals(lm_ocean_reduced),
main = "Residuals vs Fitted (Homoscedasticity Check)",
xlab = "Fitted Values", ylab = "Residuals", pch = 19, col = "blue")
abline(h = 0, col = "red", lwd = 2)
```

Check influential points

```{r}
influencePlot(lm_ocean_full)

```
## Check 42, 62, 28, 61
```{r}
influential_indices <- c(42, 61, 62, 28)
GBR_filtered <- GBR_dat[-influential_indices, ]
lm_ocean_filtered <- lm(species ~ temperature + pH + Latitude + Longitude + highBleach + mediumBleach + lowBleach, data = GBR_filtered)
summary(lm_ocean_full)
summary(lm_ocean_filtered)
```
when the influential points are removed from the model, longitude is much more significant

```{r}
coef_full <- coef(lm_ocean_full)
coef_filtered <- coef(lm_ocean_filtered)
comparison <- data.frame(Full_Model = coef_full, Filtered_Model = coef_filtered)
print(comparison)
```

```{r}
influencePlot(lm_ocean_reduced)
```
```{r}
influential_indices <- c(32, 28, 37, 62)
GBR_reduced_filtered <- GBR_dat[-influential_indices, ]
lm_red_ocean_filtered <- lm(species ~ temperature, data = GBR_filtered)
summary(lm_ocean_full)
summary(lm_ocean_filtered)
```

```{r}
coef_full <- coef(lm_ocean_full)
coef_filtered <- coef(lm_ocean_filtered)
comparison <- data.frame(Full_Model = coef_full, Filtered_Model = coef_filtered)
print(comparison)
```



Cook's distance
```{r}
plot(cooks.distance(lm_ocean_full), type = "h",
main = "Cook's Distance (Influential Points)",
ylab = "Cook's Distance", col = "darkred")
##how many SD's away from regression model
```

```{r}
plot(cooks.distance(lm_ocean_reduced), type = "h",
main = "Cook's Distance (Influential Points)",
ylab = "Cook's Distance", col = "darkred")
```

Leverage vs standardized residuals

```{r}
plot(lm_ocean_full, which = 5)
```

```{r}
plot(lm_ocean_reduced, which = 5)
```

Compare AIC and Adjusted RÂ²

```{r}
data.frame(
Model = c("Reduced", "Full"),
Adj_R2 = c(summary(lm_ocean_reduced)$adj.r.squared, summary(lm_ocean_full)$adj.r.squared),
AIC = c(AIC(lm_ocean_reduced), AIC(lm_ocean_full))
)
```

bpTest
```{r}
bptest(lm_ocean_reduced)
bptest(lm_ocean_full)
```

```{r}
ad.test(lm_ocean_full$residuals) 
ad.test(lm_ocean_reduced$residuals) 
```

```{r}
rstandard(lm_ocean_full)
```
## Multicollinearity test
```{r}
library(car)
vif(lm_ocean_full)

```
##Cross- Validation
```{r}
train_control <- trainControl(
  method = "cv",
  number = 5,
  savePredictions = "final"
)

# Train the model using 5-fold CV
cv_model <- train(
  species ~ temperature + pH + Latitude + Longitude + highBleach + mediumBleach + lowBleach,
  data = GBR_dat,
  method = "lm",
  trControl = train_control,
  metric = "RMSE"
)

cv_model
```
```{r}


# Null model (only intercept)
null_model <- lm(species ~ 1, data = GBR_dat)

# Forward selection
forward_model <- step(null_model, 
                      scope = list(lower = null_model, upper = lm_ocean_full),
                      direction = "forward")
summary(forward_model)

# Backward elimination
backward_model <- step(lm_ocean_full, direction = "backward")
summary(backward_model)

# Stepwise selection (both directions)
stepwise_model <- step(null_model, 
                       scope = list(lower = null_model, upper = lm_ocean_full),
                       direction = "both")
summary(stepwise_model)

```



## Model Selection (anova partial F test)
```{r}
anova(lm_ocean_full, lm_ocean_reduced)
anova(lm_ocean_full, lm_ocean_long)
```

# Discussion and Story


